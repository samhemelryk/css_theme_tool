YUI.add("moodle-block_css_theme_tool-csseditor",function(e,t){var n=function(e){n.superclass.constructor.apply(this,arguments)};n.prototype={styletag:null,previewtag:null,rules:[],explaineddelete:!1,cfg:{userid:0,showadvancedbodytags:!1,autosaveonchange:!0,onlyviewmyrules:!1},nodes:{savechangesbutton:null},components:{cssbuilder:null,cssviewer:null,settingsmanager:null},initializer:function(t){t.settings.userid&&(this.cfg.userid=t.settings.userid),t.settings.fullbodytags&&(this.cfg.showadvancedbodytags=t.settings.fullbodytags),t.settings.autosaveonchange&&(this.cfg.autosaveonchange=t.settings.autosaveonchange),t.settings.onlyviewmyrules&&(this.cfg.onlyviewmyrules=t.settings.onlyviewmyrules),this.publish("cssthemetool:changed");for(var n in t.css){var r=t.css[n],i=[];for(var s in r.styles)/[^;]$/.test(r.styles[s].value)&&(r.styles[s].value+=";"),i.push(r.styles[s].name+": "+r.styles[s].value);this.rules.push({selector:r.selector,styles:i,user:r.userid})}this.prepare_component_use(e.one(".block_css_theme_tool input.addrulebutton").removeAttribute("disabled"),"cssbuilder",{}),this.prepare_component_use(e.one(".block_css_theme_tool input.viewcssbutton").removeAttribute("disabled"),"cssviewer",{}),this.prepare_component_use(e.one(".block_css_theme_tool input.settingsbutton").removeAttribute("disabled"),"settings",{}),this.styletag=e.Node.create('<style type="text/css"></style>'),this.previewtag=e.Node.create('<style type="text/css"></style>'),e.one(document.body).append(this.styletag).append(this.previewtag),this.process_rules_to_stylesheet(),M.block_css_theme_tool.existingstylesheet?M.block_css_theme_tool.existingstylesheet.remove():e.all("link").each(function(e){e.getAttribute("rel")=="stylesheet"&&e.getAttribute("href").match(/block_css_theme_tool/)&&e.getAttribute("href").match(/pluginfile\.php/)&&e.remove()},this),this.nodes.savechangesbutton=e.one(".block_css_theme_tool input.savechangesbutton"),this.nodes.savechangesbutton.on("click",this.save_rules,this),this.cfg.autosaveonchange&&this.nodes.savechangesbutton.addClass("autosaveenabled"),this.on("cssthemetool:changed",function(e){this.nodes.savechangesbutton.removeAttribute("disabled"),this.cfg.autosaveonchange&&this.save_rules()},this)},prepare_component_use:function(t,n,r){this.components[n]=t.on("click",function(i){i.halt(),this.components[n].detach(),r.e=i,r.el=t,r.cssthemetool=this,e.use("moodle-block_css_theme_tool-csseditor-"+n,function(e){r.cssthemetool.components[n]=M.block_css_theme_tool["init_"+n].apply(M.block_css_theme_tool,[r])})},this)},add_rule:function(e,t){var n=!1;for(var r in this.rules)if(this.rules[r].selector==e){this.rules[r]={selector:e,styles:t},n=!0;break}return n||this.rules.push({selector:e,styles:t}),this.fire("cssthemetool:changed"),this.process_rules_to_stylesheet()},get_rule:function(e){e=e.replace(/^\s+|\s+$/g,"");for(var t in this.rules){var n=this.rules[t].selector.replace(/^\s+|\s+$/g,"");if(n==e)return this.rules[t]}return!1},delete_rule:function(e){e=e.replace(/^\s+|\s+$/g,"");for(var t in this.rules){var n=this.rules[t].selector.replace(/^\s+|\s+$/g,"");if(n==e)return delete this.rules[t],this.process_rules_to_stylesheet(),!this.explaineddelete&&!this.cfg.autosaveonchange&&(alert(M.str.block_css_theme_tool.savenotification),this.explaineddelete=!0),this.fire("cssthemetool:changed"),!0}return!1},edit_rule:function(t){t=t.replace(/^\s+|\s+$/g,"");var n=e.one(t);n?this.components.cssbuilder.show(n,t):alert(M.str.block_css_theme_tool.cannotfindnode)},save_rules:function(){var t=[];t.push("action=save"),t.push("sesskey="+M.cfg.sesskey);for(var n in this.rules){var r=this.rules[n];t.push("rules["+n+"]="+encodeURIComponent(r.selector)),t.push("styles["+n+"]="+encodeURIComponent(r.styles.join("@@@")))}this.nodes.savechangesbutton.setAttribute("disabled",!0),e.io(M.cfg.wwwroot+"/blocks/css_theme_tool/ajax.php",{method:"POST",data:t.join("&"),on:{complete:this.save_rules_callback},context:this})},save_rules_callback:function(e,t,n){},purge_rules:function(){confirm(M.str.block_css_theme_tool.purgerulesconfirm)&&e.io(M.cfg.wwwroot+"/blocks/css_theme_tool/ajax.php",{method:"POST",data:"action=purge&sesskey="+M.cfg.sesskey,on:{complete:function(){this.rules=[],this.process_rules_to_stylesheet(),alert(M.str.block_css_theme_tool.purgerulescomplete)}},context:this})},process_rules_to_stylesheet:function(){var e=[];for(var t in this.rules){if(this.cfg.onlyviewmyrules&&this.rules[t].user&&this.rules[t].user!=this.cfg.userid)continue;e.push(this.rules[t].selector+" {"+this.rules[t].styles.join("")+"}")}return this.styletag.set("innerHTML",e.join("\n")),!0},hide_components:function(){for(var e in this.components)this.components[e]&&typeof this.components[e].hide!="undefined"&&this.components[e].hide()},export_css:function(){e.io(M.cfg.wwwroot+"/blocks/css_theme_tool/ajax.php",{method:"POST",data:"id="+this.get("instanceid")+"&action=exportcss&sesskey="+M.cfg.sesskey,on:{complete:function(e,t,n){var r=window.open(t.responseText,"csstoolexport");r||alert("Popups must be allowed for this site in order for export to work")}},context:this})}},e.extend(n,e.Base,n.prototype,{NAME:"moodle-block_css_theme_tool-csseditor",ATTRS:{instanceid:{}}}),e.augment(n,e.EventTarget),M.block_css_theme_tool={instance:null,init:function(e){this.instance=new n(e)},init_css_by_js:function(e,t){this.existingstylesheet=e.Node.create('<link type="text/css" rel="stylesheet" href="'+t+'"></link>'),e.one("head").append(this.existingstylesheet)}}},"@VERSION@",{requires:["base","node","event","event-key","event-mouseenter","io"]});
